# 📱 スマホ接続トラブルシューティングガイド

スマホから「このサイトにアクセスできません」というエラーが出る場合の解決方法です。

---

## 🔍 **ステップ1: 基本確認**

### ✅ 同じWi-Fiに接続しているか?

**重要:** PCとスマホが**同じWi-Fiネットワーク**に接続されている必要があります。

#### 確認方法

**PCのWi-Fi:**
- Windows: 画面右下のWi-Fiアイコン → 接続中のネットワーク名
- Mac: 画面右上のWi-Fiアイコン → チェックマーク付きのネットワーク名

**スマホのWi-Fi:**
- 設定 → Wi-Fi → 接続中のネットワーク名

**→ 同じネットワーク名ですか?**

違う場合は、同じWi-Fiに接続してください。

---

## 🔍 **ステップ2: 正しいIPアドレスを確認**

### Windows の場合

1. **コマンドプロンプトを開く**
   - Windowsキー + R
   - `cmd` と入力
   - Enter

2. **IPアドレスを調べる**
   ```cmd
   ipconfig
   ```
   - Enter を押す

3. **IPv4 アドレスを探す**
   ```
   Wi-Fi アダプター Wi-Fi:
   
      IPv4 アドレス . . . . . . . . . . : 192.168.1.5
   ```
   - `192.168.` で始まる数字をメモ
   - ⚠️ `127.0.0.1` ではありません!
   - ⚠️ `169.254.` で始まる場合は、Wi-Fi接続に問題があります

### Mac の場合

1. **システム環境設定を開く**
   - アップルメニュー → システム環境設定

2. **ネットワークをクリック**
   - Wi-Fi を選択
   - IPアドレスが表示されます
   - 例: `192.168.1.5`

3. **または、ターミナルで確認**
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```

### スマホでアクセスするURL

```
http://192.168.1.5:3000
```
↑ 192.168.1.5 の部分を、調べたIPアドレスに置き換える

---

## 🔧 **ステップ3: ファイアウォール設定 (Windows)**

### 方法1: 受信規則を追加 (推奨)

1. **Windowsセキュリティを開く**
   - Windowsキー + I (設定)
   - 「更新とセキュリティ」
   - 「Windowsセキュリティ」
   - 「Windowsセキュリティを開く」

2. **ファイアウォール設定**
   - 「ファイアウォールとネットワーク保護」
   - 「詳細設定」をクリック

3. **新しい受信規則を作成**
   - 左側: 「受信の規則」をクリック
   - 右側: 「新しい規則...」をクリック

4. **ポート規則を選択**
   - 「ポート」を選択 → 「次へ」
   - 「TCP」を選択
   - 「特定のローカルポート」: `3000, 3001` と入力
   - 「次へ」

5. **接続を許可**
   - 「接続を許可する」を選択
   - 「次へ」

6. **適用するプロファイル**
   - すべてにチェック (ドメイン、プライベート、パブリック)
   - 「次へ」

7. **名前を設定**
   - 名前: `ワンナイト人狼`
   - 説明: `ポート3000と3001を許可`
   - 「完了」

### 方法2: コマンドで追加 (速い!)

**管理者権限でコマンドプロンプトを開く:**
1. Windowsキー
2. `cmd` と入力
3. **右クリック** → 「管理者として実行」

**以下のコマンドを実行:**
```cmd
netsh advfirewall firewall add rule name="ワンナイト人狼 3000" dir=in action=allow protocol=TCP localport=3000

netsh advfirewall firewall add rule name="ワンナイト人狼 3001" dir=in action=allow protocol=TCP localport=3001
```

**確認:**
```cmd
netsh advfirewall firewall show rule name="ワンナイト人狼 3000"
```

### 方法3: 一時的に無効化 (テスト用のみ!)

⚠️ **セキュリティリスクがあるので、テスト後は必ず有効に戻してください**

1. Windowsセキュリティ → ファイアウォールとネットワーク保護
2. 「プライベートネットワーク」をクリック
3. 「Microsoft Defender ファイアウォール」を**オフ**
4. スマホでアクセスしてみる
5. **必ずオンに戻す!**

---

## 🔧 **ステップ4: サーバー設定を確認**

### 修正版のファイルを使用する

**このZIPファイルには既に修正済みのコードが含まれています!**

もし古いバージョンを使っている場合:

1. **新しいZIPファイルをダウンロード**
2. 古いフォルダを削除
3. 新しいファイルを解凍
4. 再度セットアップ

### 手動で修正する場合

#### server/server.js の修正

**ファイルの場所:** `werewolf-project/server/server.js`

**修正1: CORS設定**

元のコード:
```javascript
const io = socketIO(server, {
  cors: {
    origin: "http://localhost:3000",
    methods: ["GET", "POST"]
  }
});
```

修正後:
```javascript
const io = socketIO(server, {
  cors: {
    origin: "*", // すべてのオリジンを許可
    methods: ["GET", "POST"],
    credentials: true
  }
});
```

**修正2: リスニングアドレス**

元のコード:
```javascript
server.listen(PORT, () => {
  console.log(`🎮 ワンナイト人狼サーバー起動: http://localhost:${PORT}`);
});
```

修正後:
```javascript
server.listen(PORT, '0.0.0.0', () => {
  console.log(`🎮 ワンナイト人狼サーバー起動: http://localhost:${PORT}`);
  console.log(`📱 スマホからアクセス: http://あなたのIPアドレス:${PORT}`);
});
```

#### client/src/socket.js の修正

**ファイルの場所:** `werewolf-project/client/src/socket.js`

元のコード:
```javascript
const SOCKET_URL = 'http://localhost:3001';
```

修正後:
```javascript
const SOCKET_URL = process.env.REACT_APP_SOCKET_URL || 
  `http://${window.location.hostname}:3001`;
```

---

## 🔄 **ステップ5: サーバーを再起動**

修正後は必ず再起動してください!

1. **両方のターミナルで Ctrl + C**
2. **左側のターミナル:**
   ```bash
   cd server
   npm start
   ```
3. **右側のターミナル:**
   ```bash
   cd client
   npm start
   ```

---

## 📱 **ステップ6: スマホで再度アクセス**

1. **スマホのブラウザを開く**
   - Chrome, Safari など

2. **URLを入力**
   ```
   http://192.168.1.5:3000
   ```
   ↑ あなたのIPアドレスに置き換える

3. **アクセス!**
   - ゲーム画面が表示されるはず

---

## 🐛 **それでもダメな場合**

### 1. ポートが開いているか確認

**管理者権限のコマンドプロンプトで:**
```cmd
netstat -an | findstr :3000
netstat -an | findstr :3001
```

**表示例:**
```
TCP    0.0.0.0:3000           0.0.0.0:0              LISTENING
TCP    0.0.0.0:3001           0.0.0.0:0              LISTENING
```

`0.0.0.0:3000` と `0.0.0.0:3001` が LISTENING になっていればOK!

`127.0.0.1:3000` となっている場合は、ステップ4のサーバー修正が必要です。

### 2. ウイルス対策ソフトを確認

- ノートン、McAfee、Avast などがブロックしている可能性
- 一時的に無効化してテスト
- または、ポート3000と3001を例外に追加

### 3. ルーターの設定

- まれにルーターが内部通信をブロックしている場合があります
- ルーターの管理画面で「APアイソレーション」が無効になっているか確認

### 4. 別のポートを試す

**server/server.js:**
```javascript
const PORT = process.env.PORT || 8080; // 3001から8080に変更
```

**client/package.json に追加:**
```json
"scripts": {
  "start": "PORT=8081 react-scripts start",
  ...
}
```

スマホでアクセス:
```
http://192.168.1.5:8081
```

---

## ✅ **チェックリスト**

接続できない場合、以下を確認してください:

- [ ] PCとスマホが同じWi-Fiに接続
- [ ] 正しいIPアドレスを使用 (192.168.x.x)
- [ ] ファイアウォールでポート3000と3001を許可
- [ ] サーバーが `0.0.0.0` でリッスンしている
- [ ] CORS設定が `*` になっている
- [ ] サーバーとクライアントが両方起動中
- [ ] ウイルス対策ソフトが邪魔していない

---

## 📞 **デバッグ情報の確認**

### PCのコンソールで確認

**ブラウザの開発者ツール:**
1. F12 キーを押す
2. Console タブを開く
3. エラーメッセージがないか確認

**ターミナルで確認:**
- サーバー側に接続ログが出ているか
```
新しいクライアント接続: xxxxx
```

### スマホのブラウザで確認

**Chromeの場合:**
1. `chrome://inspect` にPCでアクセス
2. スマホをUSB接続
3. リモートデバッグでエラー確認

---

## 💡 **よくある間違い**

### ❌ 間違い1: localhost を使っている
```
http://localhost:3000  ← スマホからは見えません!
```

### ✅ 正しい:
```
http://192.168.1.5:3000  ← IPアドレスを使う
```

### ❌ 間違い2: 127.0.0.1 を使っている
```
http://127.0.0.1:3000  ← これもダメ!
```

### ✅ 正しい:
```
http://192.168.1.5:3000  ← ローカルネットワークのIP
```

### ❌ 間違い3: ポート番号が違う
```
http://192.168.1.5:3001  ← サーバーのポート
```

### ✅ 正しい:
```
http://192.168.1.5:3000  ← クライアントのポート
```

---

## 🎉 **成功したら**

1. **名前を入力**
2. **ルームIDを入力** (PCから教えてもらう)
3. **「ルームに参加」をクリック**
4. **一緒に遊ぶ!** 🎮

---

**それでも解決しない場合は、エラーメッセージと一緒に質問してください!** 😊
